{% extends 'base.html' %}

{% block title %}{{ task.title }} - НХТК{% endblock %}

{% block content %}
<div class="project-detail">
    <div class="actions-bar">
        <a href="{{ url_for('projects.project_detail', project_id=task.project_id) }}" class="btn back-btn">Назад к проекту</a>
    </div>

    <h2>{{ task.title }}</h2>

    <div class="info-grid">
        <div class="info-item">
            <strong>Статус</strong>
            <p><span class="status-badge {% if task.status == 'активна' %}status-active{% elif task.status == 'завершена' %}status-completed{% else %}status-paused{% endif %}">{{ task.status }}</span></p>
        </div>
        <div class="info-item">
            <strong>Исполнитель</strong>
            <p>{{ assignee.name if assignee else 'Не назначен' }}</p>
        </div>
        <div class="info-item">
            <strong>Дата создания</strong>
            <p>{{ task.created_at }}</p>
        </div>
        <div class="info-item">
            <strong>Дедлайн</strong>
            <p>{{ task.deadline }}</p>
        </div>
        <div class="info-item">
            <strong>Дата начала</strong>
            <p>{{ task.start_date or 'Не указана' }}</p>
        </div>
        <div class="info-item">
            <strong>Создатель</strong>
            <p>{{ creator.name if creator else 'Неизвестно' }}</p>
        </div>
    </div>

    <div class="project-description">
        <h3>Описание</h3>
        <p>{{ task.description or 'Нет описания' }}</p>
    </div>

    {% if task.files %}
    <div class="task-files-section">
        <h4>Прикрепленные файлы</h4>
        <div class="files-list">
            {% for file in task.files %}
            <div class="file-item">
                <span>{{ file.filename }}</span>
                <small>{{ file.uploaded_at }}</small>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Task Reporting Section -->
    {% if current_user.id == task.assignee_id or current_user.role in ['admin', 'manager', 'supervisor'] %}
    <div class="task-reporting-section">
        <h4>Отчет по задаче</h4>
        <form id="reportForm" action="{{ url_for('tasks.report_task', task_id=task.id) }}" method="POST" enctype="multipart/form-data">
            <div class="form-group">
                <label for="comment">Комментарий:</label>
                <textarea id="comment" name="comment" rows="4" placeholder="Добавьте комментарий к отчету..."></textarea>
            </div>
            <div class="form-group">
                <label for="report_file">Файл (необязательно):</label>
                <input type="file" id="report_file" name="report_file" accept=".txt,.pdf,.png,.jpg,.jpeg,.gif,.doc,.docx,.xls,.xlsx">
            </div>
            <button type="submit" class="btn">Отправить отчет</button>
        </form>
    </div>
    {% endif %}

    <!-- Reports Display Section -->
    {% if task.reports %}
    <div class="task-reports-section">
        <h4>Отчеты по задаче</h4>
        <div class="reports-list">
            {% for report in task.reports|reverse %}
            <div class="report-item">
                <div class="report-header">
                    <strong>Отчет от {{ report.reported_at }}</strong>
                </div>
                <div class="report-content">
                    {% if report.comment %}
                        <p>{{ report.comment }}</p>
                    {% endif %}
                    {% if report.file %}
                    <div class="report-file">
                        <strong>Файл:</strong> 
                        <a href="/uploads/{{ report.file.executor_dir }}/{{ report.file.unique_filename }}" target="_blank">{{ report.file.filename }}</a>
                        <small>({{ report.file.size }} байт)</small>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <div class="form-actions">
        <form action="{{ url_for('tasks.update_task_status', task_id=task.id) }}" method="POST" class="status-form">
            <select name="status" class="status-select">
                <option value="активна" {% if task.status == 'активна' %}selected{% endif %}>Активна</option>
                <option value="завершена" {% if task.status == 'завершена' %}selected{% endif %}>Завершена</option>
                <option value="отложена" {% if task.status == 'отложена' %}selected{% endif %}>Отложена</option>
            </select>
            <button type="submit" class="btn">Обновить статус</button>
        </form>
    </div>
</div>

<script>
function downloadReportFile(executorDir, filename) {
    // Create a temporary link and trigger download
    const link = document.createElement('a');
    link.href = `/uploads/${executorDir}/${filename}`;
    link.target = '_blank';
    link.download = filename;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

// Handle form submission
document.getElementById('reportForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    
    try {
        const response = await fetch(this.action, {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert(result.message);
            location.reload(); // Reload the page to show the new report
        } else {
            alert('Ошибка: ' + result.error);
        }
    } catch (error) {
        alert('Ошибка при отправке отчета: ' + error.message);
    }
});
</script>
{% endblock %}
